import React, { useEffect, useState } from 'react'
import { Tag } from 'antd'
import moment from 'moment'
import { observer } from 'mobx-react'

// components
import { InfoBlock } from 'components/InfoBlock'
import { ScheduleOneDay } from 'components/ScheduleOneDay'
import { NewsItem } from 'components/NewsItem'

// hooks
import { usePageTitle } from 'hooks/pageTitle.hook'

// utils
import { fullWeekDays } from 'utils/dates'

// stores
import { AuthStore } from 'store/auth'
import { ScheduleStore } from 'store/schedule'
import { StudySpaceStore } from 'store/studySpace'

// styles
import './Feed.scss'

export const FeedContainer: React.FC = observer(() => {
    const [studyStore] = useState(StudySpaceStore)
    const [authStore] = useState(AuthStore)
    const [scheduleStore] = useState(ScheduleStore)
    const { rename } = usePageTitle('')

    const { schedule: scheduleId } = studyStore.activeGroup

    useEffect(() => {
        if(scheduleStore.data.id !== scheduleId) {
            scheduleStore.getById(scheduleId)
        }
    }, [scheduleId])

    useEffect(() => {
        rename(`${studyStore.activeGroup.name} | –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞`)
    }, [])

    const news = [
        {
            id: 1,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        },
        {
            id: 2,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        },
        {
            id: 3,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        },
        {
            id: 4,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        },
        {
            id: 5,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        },
        {
            id: 6,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        },
        {
            id: 7,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        },
        {
            id: 8,
            text: '–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Å—Å–∏–∏ –∑–∞ –æ—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä',
            photo: 'https://zvuch.com/img/collections/340290_large.jpg',
            name: '–ñ–∞–∑–≥—É–ª—å',
            lastName: '–≠–∂–µ'
        }
    ]

    const lessons = scheduleStore.loaded ? scheduleStore.lessons : []
    const { user } = authStore

    const weekDayIndex = moment().isoWeekday() - 1
    const lessonsLength = lessons.length && lessons[weekDayIndex].length
    const currentLesson = lessons[weekDayIndex] || []

    return (
        <>
            <InfoBlock 
                title={`üß† –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.firstName}!`}
                content={(
                    <>
                        <p>
                            –°–µ–≥–æ–¥–Ω—è 
                            
                            <Tag 
                                color='success' 
                                style={{ marginLeft: 4, marginRight: 0, fontSize: 14 }}
                            >
                                { moment().format('DD MMMM, ') }

                                { fullWeekDays[weekDayIndex] }
                            </Tag>
                        </p>

                        <p>
                            –£ –≤–∞—Å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é 

                            <Tag 
                                color='processing' 
                                style={{ marginLeft: 4, marginRight: 2, fontSize: 14 }}
                            >
                                { lessonsLength } 
                                
                                {' '}

                                –∑–∞–Ω—è—Ç–∏—è
                            </Tag>

                            {
                                !!lessonsLength && (
                                    <>
                                        :

                                        &nbsp;

                                        {
                                            currentLesson.map((lesson: any, index: number) => (
                                                <>
                                                    <Tag 
                                                        color={lesson.color} 
                                                        style={{ 
                                                            marginLeft: 4, 
                                                            marginRight: 0, 
                                                            fontSize: 14 
                                                        }}
                                                    >
                                                        { lesson.title }
                                                    </Tag>

                                                    {
                                                        (index + 1) !== lessonsLength && (
                                                            ', '
                                                        )
                                                    }
                                                </>
                                            ))
                                        }
                                    </>
                                )
                            }
                        </p>
                    </>
                )}
            /> 

            <div className='feed__grid' style={{ marginTop: 20 }}>
                <InfoBlock 
                    title='–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'
                    withHeader
                    content={(
                        <ScheduleOneDay 
                            classes={currentLesson}
                            isEditable={false}
                        />
                    )}
                /> 

                <InfoBlock 
                    title='–ù–µ–¥–∞–≤–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏'
                    withHeader
                    bodyStyle={{ padding: 0 }}
                    content={(
                        <div style={{ overflowY: 'auto', padding: '20px 20px 10px 20px', maxHeight: 550 }}>
                            {
                                news.map((i) => (
                                    <NewsItem { ...i } key={i.id} />
                                ))
                            }
                        </div>
                    )}
                />
            </div>
        </>
    )
})